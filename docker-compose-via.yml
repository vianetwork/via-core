version: '3.8'

services:
  bitcoind:
    image: 'lightninglabs/bitcoin-core:27'
    command:
      - -regtest
      - -server
      - -rpcbind=0.0.0.0
      - -rpcallowip=0.0.0.0/0
      - -rpcuser=rpcuser
      - -rpcpassword=rpcpassword
      - -fallbackfee=0.0002
      - -txindex
      - -printtoconsole
    ports:
      - '18443:18443'  # RPC port
      - '18444:18444'  # P2P port
    volumes:
      - type: bind
        source: ./volumes/bitcoin
        target: /home/bitcoin/.bitcoin
    environment:
      - BITCOIN_DATA=/home/bitcoin/.bitcoin

  bitcoin-cli:
    image: 'lightninglabs/bitcoin-core:27'
    depends_on:
      - bitcoind
    volumes:
      - type: bind
        source: ./volumes/bitcoin
        target: /home/bitcoin/.bitcoin
    entrypoint: /bin/sh
    command:
      - -c
      - |
        # Wait for bitcoind to be ready
        until bitcoin-cli -chain=regtest -rpcwait -rpcconnect=bitcoind -rpcuser=rpcuser -rpcpassword=rpcpassword getblockchaininfo; do
          echo "Waiting for bitcoind..."
          sleep 1
        done
        
        bitcoin-cli -chain=regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword createwallet Alice
        ALICE_ADDRESS=$(bitcoin-cli -chain=regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword -rpcwallet=Alice getnewaddress)
        bitcoin-cli -chain=regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword generatetoaddress 201 $${ALICE_ADDRESS}
        echo "Alice's address: $${ALICE_ADDRESS}"
        
        # Generate initial blocks to fund 'Alice'
        bitcoin-cli -chain=regtest -rpcwait -rpcconnect=bitcoind -rpcuser=rpcuser -rpcpassword=rpcpassword generatetoaddress 201 $ALICE_ADDRESS
        
        # Start generating blocks every 10 seconds
        while true; do
            bitcoin-cli -regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword generatetoaddress 1 $${ALICE_ADDRESS}
            sleep 10 &
            wait $!
        done
    environment:
      - BITCOIN_DATA=/home/bitcoin/.bitcoin

  postgres:
    image: 'postgres:14'
    command: postgres -c 'max_connections=200'
    ports:
      - '127.0.0.1:5432:5432'
    volumes:
      - type: bind
        source: ./volumes/postgres
        target: /var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=notsecurepassword

volumes:
  bitcoin_data:
