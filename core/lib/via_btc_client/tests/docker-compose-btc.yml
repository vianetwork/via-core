version: "3.8"
services:
  bitcoind:
    image: "lightninglabs/bitcoin-core:25"
    command:
      - -regtest
      - -server
      - -rpcbind=0.0.0.0
      - -rpcallowip=0.0.0.0/0
      - -rpcuser=rpcuser
      - -rpcpassword=rpcpassword
      - -fallbackfee=0.0002
      - -txindex
    ports:
      - "18443:18443"
    volumes:
      - bitcoin_data:/home/bitcoin/.bitcoin

  bitcoin-cli:
    image: "lightninglabs/bitcoin-core:25"
    environment:
      - ALICE_PRIVATE_KEY=cNxiyS3cffhwK6x5sp72LiyhvP7QkM8o4VDJVLya3yaRXc3QPJYc
    command:
      - /bin/sh
      - -c
      - |
        bitcoin-cli -regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword createwallet Alice
        bitcoin-cli -regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword -rpcwallet=Alice importprivkey $${ALICE_PRIVATE_KEY} "Alice's Key" true
        ALICE_ADDRESS=$$(bitcoin-cli -regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword -rpcwallet=Alice getnewaddress)
        bitcoin-cli -regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword generatetoaddress 101 $${ALICE_ADDRESS}
        echo "Alice's address: $${ALICE_ADDRESS}"
        echo "Alice's private key: $${ALICE_PRIVATE_KEY}"
        trap 'exit 130' TERM INT EXIT
        while true; do
            bitcoin-cli -regtest -rpcconnect=bitcoind -rpcwait -rpcuser=rpcuser -rpcpassword=rpcpassword generatetoaddress 1 $${ALICE_ADDRESS}
            sleep 10 &
            wait $!
        done

volumes:
  bitcoin_data:
    name: bitcoin_data