use std::sync::Arc;

use anyhow::Result;
use bitcoin::Txid;
use via_btc_client::{
    indexer::MessageParser,
    traits::BitcoinOps,
    types::{BitcoinNetwork, NodeAuth, TransactionWithMetadata},
};

use bitcoin::consensus::encode::deserialize;
use bitcoin::Transaction;

#[tokio::main]
async fn main() -> Result<()> {
    tracing_subscriber::fmt()
        .with_max_level(tracing::Level::INFO)
        .init();

    let hex_tx = "020000000001021a072feaa08e2d7420aa076ea3f45e3a55d9fc83e1f7b04dd793e3b2ca96f5ca0000000000fdffffff1a072feaa08e2d7420aa076ea3f45e3a55d9fc83e1f7b04dd793e3b2ca96f5ca0100000000fdffffff0135fc5f0100000000160014166cc9ceb2c1899fe8d0f04c2dcbc7d19dc855d302483045022100f136004248289b25ed78aec62defff4c82cbc9e4316c520a9a00a6533bae805e02202b02a37ae062ffe621d453bd50a22519acbe530626fe78b415f558556fce4656012102ef289161991b3097006b3aa9dfd931fd33ad51536873b9a5bee7e71b41da56570341d41a23725960f0df6548245c05158a4d97a43349b52f7860fb5bb2779984bd56f2d1797ba3bd31818faf8b8fdcdebb74c0e452fb519532e003681755180db30a01fdee0120ef289161991b3097006b3aa9dfd931fd33ad51536873b9a5bee7e71b41da5657ac0063187669615f696e736372697074696f6e5f70726f746f636f6c1a53797374656d426f6f74737472617070696e674d6573736167650400018a1b200000000000000000000000000000000000000000000000000000001c0000000020010008c3be57ae5800e077b6c2056d9d75ad1a7b4f0ce583407961cc6fe0b678200100055d4fb8cb4bf017843c74ea924928235a8954b327a1e2a88a7568a04b102014f97b81e54b35fe673d8708cc1a19e1ea5b5e348e12d31e39824ed4f42bbca22000000000000000000000000000000000000000000000000000000000000000002a746231717a656b766e6e346a637879656c3678733770787a6d6a3738367877757334776e7168783665772a746231717a656b766e6e346a637879656c3678733770787a6d6a3738367877757334776e7168783665773e74623170707379386a38306a746e733432726b7064736663763235716673636871656a786d6b366461746b767532333665656b7234666d733036776e7a302a74623171636a32777672793637756d6c6a64773876386a36787761666b74713234636472656a7533686e2a74623171356a71757476616d6e7875646377616e39766e326c303364687767653563646563796475616b6821c1ef289161991b3097006b3aa9dfd931fd33ad51536873b9a5bee7e71b41da565700000000";

    // 1. Decode hex string into raw bytes
    let raw_tx = hex::decode(hex_tx).expect("invalid hex");

    // 2. Deserialize bytes into a bitcoin::Transaction
    let tx: Transaction = deserialize(&raw_tx).expect("invalid transaction");

    let mut parser = MessageParser::new(BitcoinNetwork::Testnet4);
    let messages = parser.parse_system_transaction(&tx, 0, None);

    println!("messages: {:?}", messages);

    Ok(())
}
